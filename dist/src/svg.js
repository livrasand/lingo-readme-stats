"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.renderDuolingoCard = renderDuolingoCard;
const themes_1 = require("./themes");
const duolingo_1 = require("./duolingo");
function escapeXml(unsafe) {
    return unsafe.replace(/[<>&'"]/g, function (c) {
        switch (c) {
            case '<': return '&lt;';
            case '>': return '&gt;';
            case '&': return '&amp;';
            case '\'': return '&apos;';
            case '"': return '&quot;';
            default: return c;
        }
    });
}
function renderDuolingoCard(profile, opts = {}) {
    const selectedTheme = themes_1.themes[opts.theme || 'default'] || themes_1.themes.default;
    const hide = new Set((opts.hide || []).map(h => h.toLowerCase()));
    const name = escapeXml(profile.name ?? profile.username ?? 'Unknown');
    const username = escapeXml(profile.username ?? '');
    const xp = profile.totalXp ?? 0;
    const level = (0, duolingo_1.translateXpToLevels)(xp);
    const streak = profile.streak ?? 0;
    // Some simple layout & sizing
    const width = 520;
    const height = 160;
    const padding = 20;
    const titleY = 42;
    // optional fields visibility
    const showXP = !hide.has('xp') && !hide.has('totalxp');
    const showLevel = !hide.has('level');
    const showStreak = !hide.has('streak');
    // avatar if exists (Duolingo avatars often reachable via full URL)
    const avatarUrlRaw = profile.picture ? String(profile.picture) : null;
    const avatarUrl = avatarUrlRaw ? escapeXml(avatarUrlRaw) : null;
    // Construct SVG
    const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="${name} Duolingo stats">
  <style>
    .card { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .title { font-size: 22px; font-weight: 700; fill: ${selectedTheme.titleColor}; }
    .meta { font-size: 14px; fill: ${selectedTheme.textColor}; font-weight: 500; }
    .accent { fill: ${selectedTheme.accent}; font-weight: 700; font-size: 16px; }
    .subtle { fill: ${selectedTheme.textColor}; opacity: 0.8; font-size: 12px; }
  </style>

  <rect x="0.5" y="0.5" rx="12" width="${width - 1}" height="${height - 1}" fill="${selectedTheme.bg}" stroke="${selectedTheme.border}" stroke-width="3" />
  ${avatarUrl ? `<defs>
    <clipPath id="avatarClip"><circle cx="${padding + 32}" cy="${titleY}" r="28" /></clipPath>
  </defs>
  <image x="${padding + 4}" y="${titleY - 28}" width="56" height="56" preserveAspectRatio="xMidYMid slice" clip-path="url(#avatarClip)" href="${avatarUrl}" />` : ''}

  <g class="card">
    <text x="${padding + (avatarUrl ? 64 : 0)}" y="${titleY - 6}" class="title">${name}</text>
    <text x="${padding + (avatarUrl ? 64 : 0)}" y="${titleY + 14}" class="meta">${username}</text>

    <g transform="translate(${padding}, ${titleY + 55})">
      ${showXP ? `<g transform="translate(0, 0)">
<g transform="scale(1.14)">
<path fill-rule="evenodd" clip-rule="evenodd" d="M14.0367 2.67272C13.8379 0.718003 11.3282 0.0455378 10.1787 1.63898L0.717665 14.7538C-0.157342 15.9667 0.452676 17.6801 1.89732 18.0672L7.2794 19.5093L8.07445 27.3273C8.27323 29.282 10.7829 29.9545 11.9324 28.361L21.3935 15.2462C22.2685 14.0333 21.6585 12.3199 20.2138 11.9328L14.8317 10.4907L14.0367 2.67272Z" fill="#FFD900"/>
<path d="M2.574 16.4882C2.08457 16.3561 2.03731 15.6803 2.50359 15.4813L6.24415 13.8853C6.58188 13.7412 6.96093 13.973 6.98654 14.3393L7.17226 16.9952C7.19787 17.3615 6.85477 17.6438 6.50027 17.5481L2.574 16.4882Z" fill="#F7C100"/>
<path d="M19.717 13.2505C20.2064 13.3826 20.2537 14.0584 19.7874 14.2573L16.0469 15.8533C15.7091 15.9974 15.3301 15.7656 15.3045 15.3993L15.1188 12.7435C15.0931 12.3772 15.4362 12.0949 15.7907 12.1906L19.717 13.2505Z" fill="#FFEF8F"/>
</g>
<text x="30" y="12" class="subtle">XP</text>
<text x="30" y="28" class="accent">${xp.toLocaleString()}</text>
</g>` : ''}

      ${showLevel ? `<g transform="translate(160, 0) scale(0.64)">
        <g clip-path="url(#clip0_129_593)">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M12.563 0H57.437C61.8054 0 63.3895 0.454846 64.9865 1.30895C66.5836 2.16305 67.8369 3.41642 68.691 5.01346C69.5452 6.61049 70 8.1946 70 12.563V41.437C70 45.8054 69.5452 47.3895 68.691 48.9865C67.8369 50.5836 66.5836 51.8369 64.9865 52.6911C63.3895 53.5452 61.8054 54 57.437 54H12.563C8.1946 54 6.61049 53.5452 5.01346 52.6911C3.41642 51.8369 2.16305 50.5836 1.30895 48.9865C0.454846 47.3895 0 45.8054 0 41.437V12.563C0 8.1946 0.454846 6.61049 1.30895 5.01346C2.16305 3.41642 3.41642 2.16305 5.01346 1.30895C6.61049 0.454846 8.1946 0 12.563 0Z" fill="#EEEEEE"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M12.563 0H57.437C61.8054 0 63.3895 0.454846 64.9865 1.30895C66.5836 2.16305 67.8369 3.41642 68.691 5.01346C68.8631 5.3352 69.019 5.65643 69.1582 6H0.841797C0.981005 5.65643 1.13687 5.3352 1.30895 5.01346C2.16305 3.41642 3.41641 2.16305 5.01345 1.30895C6.61049 0.454846 8.19459 0 12.563 0Z" fill="#FF4B4B"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M69.9973 12C69.9991 12.1824 70 12.37 70 12.563V18H0V12.563C0 12.37 0.000888148 12.1824 0.00265965 12H69.9973Z" fill="#FF4B4B"/><path fill-rule="evenodd" clip-rule="evenodd" d="M70 24V30H0V24H70Z" fill="#FF4B4B"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M70 41.437C70 41.63 69.9991 41.8176 69.9973 42H0.00265965C0.000888148 41.8176 0 41.63 0 41.437V36H70V41.437Z" fill="#FF4B4B"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M69.1582 48C69.019 48.3436 68.8631 48.6648 68.691 48.9865C67.8369 50.5836 66.5836 51.8369 64.9865 52.6911C63.3895 53.5452 61.8054 54 57.437 54H12.563C8.19459 54 6.61049 53.5452 5.01345 52.6911C3.41641 51.8369 2.16305 50.5836 1.30895 48.9865C1.13687 48.6648 0.981005 48.3436 0.841797 48H69.1582Z" fill="#FF4B4B"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M12.563 0H35V24H0V12.563C0 8.1946 0.454846 6.61049 1.30895 5.01346C2.16305 3.41642 3.41642 2.16305 5.01346 1.30895C6.61049 0.454846 8.1946 0 12.563 0Z" fill="#1CB0F6"/>
        <path d="M27.8065 9.60198L26.531 10.2726C26.1304 10.4832 25.635 10.3292 25.4245 9.92863C25.3406 9.76914 25.3117 9.58645 25.3421 9.40885L25.5857 7.98849C25.6089 7.85332 25.5641 7.71541 25.4659 7.61968L24.434 6.61377C24.1099 6.29791 24.1033 5.77918 24.4191 5.45514C24.5449 5.32611 24.7097 5.24214 24.888 5.21623L26.3142 5.009C26.4499 4.98928 26.5672 4.90404 26.6279 4.78107L27.2657 3.48877C27.4659 3.08299 27.9572 2.91639 28.363 3.11665C28.5246 3.1964 28.6554 3.32719 28.7351 3.48877L29.3729 4.78107C29.4336 4.90404 29.5509 4.98928 29.6867 5.009L31.1128 5.21623C31.5606 5.2813 31.8709 5.69707 31.8058 6.14487C31.7799 6.32319 31.6959 6.48799 31.5669 6.61377L30.5349 7.61968C30.4367 7.71541 30.3919 7.85332 30.4151 7.98849L30.6587 9.40885C30.7352 9.85485 30.4357 10.2784 29.9897 10.3549C29.8121 10.3854 29.6294 10.3564 29.4699 10.2726L28.1943 9.60198C28.0729 9.53816 27.9279 9.53816 27.8065 9.60198Z" fill="white"/><path d="M27.8065 19.602L26.531 20.2726C26.1304 20.4832 25.635 20.3292 25.4245 19.9286C25.3406 19.7691 25.3117 19.5865 25.3421 19.4089L25.5857 17.9885C25.6089 17.8533 25.5641 17.7154 25.4659 17.6197L24.434 16.6138C24.1099 16.2979 24.1033 15.7792 24.4191 15.4551C24.5449 15.3261 24.7097 15.2421 24.888 15.2162L26.3142 15.009C26.4499 14.9893 26.5672 14.904 26.6279 14.7811L27.2657 13.4888C27.4659 13.083 27.9572 12.9164 28.363 13.1167C28.5246 13.1964 28.6554 13.3272 28.7351 13.4888L29.3729 14.7811C29.4336 14.904 29.5509 14.9893 29.6867 15.009L31.1128 15.2162C31.5606 15.2813 31.8709 15.6971 31.8058 16.1449C31.7799 16.3232 31.6959 16.488 31.5669 16.6138L30.5349 17.6197C30.4367 17.7154 30.3919 17.8533 30.4151 17.9885L30.6587 19.4089C30.7352 19.8549 30.4357 20.2784 29.9897 20.3549C29.8121 20.3854 29.6294 20.3564 29.4699 20.2726L28.1943 19.602C28.0729 19.5382 27.9279 19.5382 27.8065 19.602Z" fill="white"/><path d="M17.8065 9.60198L16.531 10.2726C16.1304 10.4832 15.635 10.3292 15.4245 9.92863C15.3406 9.76914 15.3117 9.58645 15.3421 9.40885L15.5857 7.98849C15.6089 7.85332 15.5641 7.71541 15.4659 7.61968L14.434 6.61377C14.1099 6.29791 14.1033 5.77918 14.4191 5.45514C14.5449 5.32611 14.7097 5.24214 14.888 5.21623L16.3142 5.009C16.4499 4.98928 16.5672 4.90404 16.6279 4.78107L17.2657 3.48877C17.466 3.08299 17.9572 2.91639 18.363 3.11665C18.5246 3.1964 18.6554 3.3272 18.7351 3.4888L19.3729 4.7811C19.4336 4.904 19.5509 4.9893 19.6867 5.009L21.1128 5.2162C21.5606 5.2813 21.8709 5.6971 21.8058 6.1449C21.7799 6.3232 21.6959 6.488 21.5669 6.6138L20.5349 7.6197C20.4367 7.7154 20.3919 7.8533 20.4151 7.9885L20.6587 9.4089C20.7352 9.8549 20.4357 10.2784 19.9897 10.3549C19.8121 10.3854 19.6294 10.3564 19.4699 10.2726L18.1943 9.60198C18.0729 9.5382 17.9279 9.5382 17.8065 9.60198Z" fill="white"/><path d="M17.8065 19.602L16.531 20.2726C16.1304 20.4832 15.635 20.3292 15.4245 19.9286C15.3406 19.7691 15.3117 19.5865 15.3421 19.4089L15.5857 17.9885C15.6089 17.8533 15.5641 17.7154 15.4659 17.6197L14.434 16.6138C14.1099 16.2979 14.1033 15.7792 14.4191 15.4551C14.5449 15.3261 14.7097 15.2421 14.888 15.2162L16.3142 15.009C16.4499 14.9893 16.5672 14.904 16.6279 14.7811L17.2657 13.4888C17.466 13.083 17.9572 12.9164 18.363 13.1167C18.5246 13.1964 18.6554 13.3272 18.7351 13.4888L19.3729 14.7811C19.4336 14.904 19.5509 14.9893 19.6867 15.009L21.1128 15.2162C21.5606 15.2813 21.8709 15.6971 21.8058 16.1449C21.7799 16.3232 21.6959 16.488 21.5669 16.6138L20.5349 17.6197C20.4367 17.7154 20.3919 17.8533 20.4151 17.9885L20.6587 19.4089C20.7352 19.8549 20.4357 20.2784 19.9897 20.3549C19.8121 20.3854 19.6294 20.3564 19.4699 20.2726L18.1943 19.602C18.0729 19.5382 17.9279 19.5382 17.8065 19.602Z" fill="white"/><path d="M7.80652 9.60198L6.53095 10.2726C6.13042 10.4832 5.63503 10.3292 5.42446 9.92863C5.34061 9.76914 5.31167 9.58645 5.34213 9.40885L5.58575 7.98849C5.60893 7.85332 5.56412 7.71541 5.46591 7.61968L4.43395 6.61377C4.10992 6.29791 4.10329 5.77918 4.41915 5.45514C4.54492 5.32611 4.70973 5.24214 4.88804 5.21623L6.31418 5.009C6.44989 4.98928 6.56721 4.90404 6.6279 4.78107L7.26569 3.48877C7.46595 3.08299 7.95725 2.91639 8.36303 3.11665C8.52461 3.1964 8.6554 3.32719 8.73515 3.48877L9.37293 4.78107C9.43363 4.90404 9.55095 4.98928 9.68666 5.009L11.1128 5.21623C11.5606 5.2813 11.8709 5.69707 11.8058 6.14487C11.7799 6.32319 11.6959 6.48799 11.5669 6.61377L10.5349 7.61968C10.4367 7.71541 10.3919 7.85332 10.4151 7.98849L10.6587 9.40885C10.7352 9.85485 10.4357 10.2784 9.98966 10.3549C9.81206 10.3854 9.62937 10.3564 9.46988 10.2726L8.19431 9.60198C8.07292 9.53816 7.92791 9.53816 7.80652 9.60198Z" fill="white"/><path d="M7.80652 19.602L6.53095 20.2726C6.13042 20.4832 5.63503 20.3292 5.42446 19.9286C5.34061 19.7691 5.31167 19.5865 5.34213 19.4089L5.58575 17.9885C5.60893 17.8533 5.56412 17.7154 5.46591 17.6197L4.43395 16.6138C4.10992 16.2979 4.10329 15.7792 4.41915 15.4551C4.54492 15.3261 4.70973 15.2421 4.88804 15.2162L6.31418 15.009C6.44989 14.9893 6.56721 14.904 6.6279 14.7811L7.26569 13.4888C7.46595 13.083 7.95725 12.9164 8.36303 13.1167C8.52461 13.1964 8.6554 13.3272 8.73515 13.4888L9.37293 14.7811C9.43363 14.904 9.55095 14.9893 9.68666 15.009L11.1128 15.2162C11.5606 15.2813 11.8709 15.6971 11.8058 16.1449C11.7799 16.3232 11.6959 16.488 11.5669 16.6138L10.5349 17.6197C10.4367 17.7154 10.3919 17.8533 10.4151 17.9885L10.6587 19.4089C10.7352 19.8549 10.4357 20.2784 9.98966 20.3549C9.81206 20.3854 9.62937 20.3564 9.46988 20.2726L8.19431 19.602C8.07292 19.5382 7.92791 19.5382 7.80652 19.602Z" fill="white"/>
        </g>
        <defs><clipPath id="clip0_129_593"><rect width="70" height="54" fill="white"/></clipPath></defs>
<text x="80" y="17" style="font-size:20px;" class="subtle">Level</text>
<text x="80" y="43" style="font-size:26px;" class="accent">${level}</text>
</g>` : ''}

      ${showStreak ? `<g transform="translate(320, 0) scale(1.35)">
<g transform="scale(1.5)">
<path d="M6.77271 0.532617C7.336 -0.177539 8.414 -0.177539 8.97729 0.532616L14.0623 6.94342C15.1193 8.23421 15.75 9.86374 15.75 11.6351C15.75 15.8233 12.2242 19.2185 7.875 19.2185C3.52576 19.2185 0 15.8233 0 11.6351C0 11.3414 0.0173457 11.0515 0.0511046 10.7664L0.0333507 4.37841C0.0307386 3.43858 0.542464 2.74527 1.41725 2.89269C1.59157 2.92207 1.9601 3.0331 2.12522 3.12149L3.94611 4.09617L6.77271 0.532617Z" fill="#FF9600"/>
<path d="M8.40677 8.24144C8.1299 7.86443 7.5667 7.86443 7.28982 8.24144L5.30202 10.9482C5.28343 10.9735 5.2689 11 5.25814 11.027C4.7842 11.5866 4.5 12.3011 4.5 13.0796C4.5 14.8745 6.01104 16.3296 7.875 16.3296C9.73896 16.3296 11.25 14.8745 11.25 13.0796C11.25 12.2008 10.8878 11.4035 10.2993 10.8185L8.40677 8.24144Z" fill="#FFC800"/>
</g>
<text x="28" y="8" style="font-size:9px;" class="subtle">Streak</text>
<text x="28" y="22" style="font-size:14px;" class="accent">${streak}</text>
</g>` : ''}
    </g>
  </g>
</svg>`;
    return svg;
}
